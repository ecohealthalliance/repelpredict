---
title: "REPEL network eval"
output: 
  html_document:
    keep_md: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 13, fig.height = 10)
devtools::load_all()
library(ggplot2)
library(lme4)

scale2 <- function(x, na.rm = FALSE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)


cbp1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# Load model
mod <- read_rds(here::here("tmp/lme_mod_all_diseases.rds"))
```

```{r summary}
summary(mod)

```

```{r coef-plots}

# Random effects
randef <- ranef(mod)
randef_disease <- randef$disease %>%
  tibble::rownames_to_column(var = "disease") %>%
  as_tibble()
# randef_country <- randef$country_iso3c %>%
#   tibble::rownames_to_column(var = "country_disease") %>%
#   as_tibble() %>%
#   separate(country_disease, into = c("country", "disease"), sep = ":") %>%
#   rename(intercept = `(Intercept)` )
# fixdef <- fixef(mod)

randef_disease_long <- randef_disease %>%
  filter(disease %in% get_oie_high_importance_diseases()) %>%
  pivot_longer(-disease) %>%
  mutate(disease = str_replace_all(disease, "_", " "))

vars_clean <- c("No shared border with one or more country with existing outbreaks",
                       "Shared border with one or more country with existing outbreaks",
                       "Trade value of animal products from countries with existing outbreaks",
                       "Livestock (heads) from countries with existing outbreaks"
                       )
names(vars_clean) <- unique(randef_disease_long$name)


randef_coeffs <- purrr::map(unique(randef_disease_long$name), function(var){
  dat <- randef_disease_long %>%
    filter(name == var) %>%
    mutate(disease = forcats::fct_reorder(disease, value)) %>%
    mutate(pos = value > 0)
  title <- vars_clean[var]
  ggplot(dat) +
    geom_hline(aes(yintercept = 0), color = "gray50") +
    geom_point(aes(x = disease, y = value, color = pos), size = 2) +
    geom_segment(aes(x = disease, xend = disease, y = value, yend = 0, color = pos)) +
    scale_color_manual(values = c("TRUE" = "#0072B2", "FALSE" = "#D55E00")) +
    labs(x = "", y = "", title = title) +
    coord_flip() +
    theme_minimal() +
    theme(legend.position = "none", axis.text = element_text(size = 12)) +
    NULL

})

randef_coeffs[[3]]
randef_coeffs[[4]]
```

```{r predict}

augmented_data_training <- vroom::vroom(here::here("tmp/network_augmented_data.csv.gz"))  %>%
  select(country_iso3c, disease, month, outbreak_start,
         shared_borders_from_outbreaks,
         ots_trade_dollars_from_outbreaks,
         fao_livestock_heads_from_outbreaks) %>%
  drop_na() %>%
  mutate(country_iso3c = as.factor(country_iso3c)) %>%
  mutate(disease = as.factor(disease)) %>%
  mutate_if(is.numeric, scale2)

# validated
# valdat <- repel_validation(model_object, conn) %>%
#   select(country_iso3c, disease, month)

# augmented_data_val <- repel_augment(model_object, conn, newdata = valdat)
# vroom::vroom_write(augmented_data_val, gzfile("tmp/network_augmented_data_val.csv.gz"))
augmented_data_val <- vroom::vroom(here::here("tmp/network_augmented_data_val.csv.gz"))  %>%
  dplyr::select(country_iso3c, disease, month, outbreak_start,
                shared_borders_from_outbreaks,
                ots_trade_dollars_from_outbreaks,
                fao_livestock_heads_from_outbreaks) %>%
  drop_na() %>%
  mutate(country_iso3c = as.factor(country_iso3c)) %>%
  mutate(disease = as.factor(disease)) %>%
  mutate_if(is.numeric, scale2)

# resample validation
augmented_data_val_bootstrap <- augmented_data_val %>%
  rsample::bootstraps(times = 1) %>%
  pull(splits) %>%
  magrittr::extract2(1) %>%
  as_tibble() %>%
  mutate(outbreak_start_predicted = predict(mod, ., type = "response"))

# get predicted outbreak start probability by condition
augmented_data_val_compressed <- augmented_data_val_bootstrap %>%
  distinct(country_iso3c, disease, shared_borders_from_outbreaks, ots_trade_dollars_from_outbreaks, fao_livestock_heads_from_outbreaks, outbreak_start_predicted) %>%
  rename(outbreak_start_predict_prob = outbreak_start_predicted)

# get actual outbreak start probability by condition from the full dataset
augmented_data_all_compressed <- augmented_data_training %>%
  bind_rows(augmented_data_val) %>%
  group_by(country_iso3c, disease, shared_borders_from_outbreaks, ots_trade_dollars_from_outbreaks, fao_livestock_heads_from_outbreaks) %>%
  summarize(outbreak_start_actual_prob = sum(outbreak_start)/n()) %>%
  ungroup()

# compare validation predicted against actual prob
validation_outbreak_comp <- augmented_data_val_compressed %>%
  left_join(augmented_data_all_compressed)

ggplot(validation_outbreak_comp, aes(x = outbreak_start_actual_prob, y = outbreak_start_predict_prob)) +
  geom_point() +
  scale_x_continuous(limits = c(0,1)) +
  #scale_y_continuous(limits = c(0,1)) +
  NULL

```

