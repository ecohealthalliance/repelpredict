---
title: "REPEL network eval"
output: 
  html_document:
    keep_md: TRUE
---

<small>_Click on the_ ▶ _︎arrows to expand sections._</small>


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 7, fig.height = 5)
devtools::load_all()
library(ggplot2)
library(ggrepel)
library(ggthemes)
library(patchwork)
library(purrr)
library(lme4)
library(binom)
library(knitr)
library(forcats)
library(lmtest)

set.seed(990)

cbp1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

conn <- repeldata::repel_remote_conn()
model_object <- network_lme_model()

traindat <- repel_training(model_object, conn)
augmented_data_training <- repel_augment(model_object = model_object, conn = conn, newdata = traindat) #%>% 

valdat <- repel_validation(model_object, conn) 
augmented_data_val <- repel_augment(model_object, conn, newdata = valdat) #%>% 
augmented_data_val_bootstrap <- augmented_data_val %>% # resample validation
  rsample::bootstraps(times = 1) %>%
  pull(splits) %>%
  magrittr::extract2(1) %>%
  as_tibble()

```

```{r lme mods}
# Load model
model_object <-  network_lme_model(
  network_model = aws.s3::s3readRDS(bucket = "repeldb/models", object = "lme_mod_network.rds"),
  network_scaling_values = aws.s3::s3readRDS(bucket = "repeldb/models", object = "network_scaling_values.rds")
)
lme_mod <- model_object$network_model
network_scaling_values <- model_object$network_scaling_values

# Load baseline model
model_object_baseline <-  network_baseline_model(
  network_model = aws.s3::s3readRDS(bucket = "repeldb/models", object = "lme_mod_network_baseline.rds"),
  network_scaling_values = aws.s3::s3readRDS(bucket = "repeldb/models", object = "network_scaling_values_baseline.rds")
)
lme_mod_baseline <- model_object_baseline$network_model
network_scaling_values_baseline <- model_object_baseline$network_scaling_values
```


<details>
<summary>residuals</summary>
```{r lme-resids}
residuals <- tibble::enframe(resid(lme_mod))

plot(lme_mod, disease ~ resid(.), abline = 0 )

ggplot(residuals, aes(x = value)) + 
  geom_histogram(bins = 100) +
  theme_minimal()
```
</details>

<details>
<summary>model summary</summary>
```{r lme-rand-effs}
lm_mod_sum <- summary(lme_mod)
lm_mod_sum

lm_mod_vars <- map_dfr(lm_mod_sum$varcor, function(x){
  map_dbl(1:ncol(x), ~x[.,.]) %>%
    tibble::enframe(value = "variance") %>%
    mutate(name = colnames(x)) %>% 
    rename("variable" = name)
}) %>% 
  mutate(variable = str_replace(variable, "_from_outbreaks", " from countries with existing outbreak"),
         #   variable = str_replace(variable, "ots_trade_dollars", "trade value of animal products"),
         variable = str_replace(variable, "fao_trade_", ""),
         variable = str_replace(variable, "_other", " (other)"),
         variable = str_replace_all(variable, "_", " "),
         variable = str_remove(variable, "continent")) %>% 
  arrange(-variance) %>% 
  mutate(variance = signif(variance, 2))


# lm_mod_vars <- bind_rows(lm_mod_vars,
#                          tibble(variable = "residual variance", variance = 100-sum(lm_mod_vars$variance))) %>% 
#   arrange(-variance)
# # ^? variance among slopes, or variance explained in data?

knitr::kable(lm_mod_vars)
write_csv(lm_mod_vars, file = here::here("inst", "reports",  "tables", "network_variance_summary.csv"))


```
</details>

```{r prep-lme-coef-plots}
# Random effects
randef <- ranef(lme_mod) # same as coef(lme_mod) because we don't have fixed effects. random effect values represent the slopes.

randef_disease <- randef$disease %>%
  tibble::rownames_to_column(var = "disease") %>%
  as_tibble() 

randef_disease_long <- randef_disease %>%
  pivot_longer(-disease, names_to = "variable", values_to = "coef") 

randef_disease_long_formatted <- randef_disease_long %>% 
  mutate(variable = str_replace(variable, "_from_outbreaks", " from countries with existing outbreak"),
         #   variable = str_replace(variable, "ots_trade_dollars", "trade value of animal products"),
         variable = str_replace(variable, "fao_trade_", ""),
         variable = str_replace(variable, "_other", " (other)"),
         variable = str_replace_all(variable, "_", " "),
         variable = str_remove(variable, "continent"),
         variable = str_replace(variable, "shared borders from countries with existing outbreak", "shared borders with country with existing outbreak"))

lme_coeffs <- purrr::map(unique(randef_disease_long_formatted$variable), function(var){
  dat <- randef_disease_long_formatted %>%
    filter(variable == var) %>%
    mutate(pos = coef > 0)
  
  dat <- dat %>% 
    filter(disease %in% get_oie_high_importance_diseases()) %>% 
    mutate(disease = str_replace_all(disease, "_", " ")) %>% 
    mutate(disease = forcats::fct_reorder(disease, coef))
  title <- var
  ggplot(dat) +
    geom_hline(aes(yintercept = 0), color = "gray50") +
    geom_point(aes(x = disease, y = coef, color = pos), size = 2) +
    geom_segment(aes(x = disease, xend = disease, y = coef, yend = 0, color = pos)) +
    #    scale_y_continuous(limits = c(xmin,  xmax)) +
    scale_color_manual(values = c("TRUE" = "#0072B2", "FALSE" = "#D55E00")) +
    labs(y = "Coefficient", x = "", title = title) +
    coord_flip() +
    theme_minimal() +
    theme(legend.position = "none", 
          axis.text.y = element_text(size = 12, face = "bold"), 
          axis.text.x = element_text(size = 10), 
          plot.title= element_text(size = 14,  face = "bold"),
          plot.title.position = "plot") +
    NULL
  
})


names(lme_coeffs) <- unique(randef_disease_long_formatted$variable)
```


```{r lme-var-by-disease, include = FALSE}
src_lme <- map_chr(seq_along(lme_coeffs), ~ {
  tab_name <- names(lme_coeffs[.x])
  knit_expand(text = c("<details>",
                       "<summary>{{tab_name}}</summary>",
                       "```{r lme-coef-{{.x}}, echo = FALSE, align = 'left'}", 
                       "lme_coeffs[[{{.x}}]]",
                       "```",
                       "</details>"))
})

```

`r knit_child(text = src_lme)`

<details>
<summary>all</summary>
```{r lme-coef-all, fig.width = 18, fig.height = 14}
p1 <- patchwork::wrap_plots(lme_coeffs$Africa, lme_coeffs$Americas, lme_coeffs$Asia, lme_coeffs$Europe, lme_coeffs$Oceania)
ggsave(filename = here::here("inst/reports/network_model_eval_files", "lme_coefs_continents.png"), width = 16, height = 12, dpi = "print")

patchwork::wrap_plots(lme_coeffs$`log gdp dollars`, lme_coeffs$`log human population`, lme_coeffs$`log target taxa population`, lme_coeffs$`log veterinarians`)
ggsave(filename = here::here("inst/reports/network_model_eval_files", "lme_coefs_country_attributes.png"), width = 16, height = 12, dpi = "print")


patchwork::wrap_plots(lme_coeffs$`shared borders with country with existing outbreak`, lme_coeffs$`ots trade dollars from countries with existing outbreak`, lme_coeffs$`fao livestock heads from countries with existing outbreak`, lme_coeffs$`n migratory wildlife from countries with existing outbreak`)
ggsave(filename = here::here("inst/reports/network_model_eval_files", "lme_coefs_connect.png"), width = 16, height = 12, dpi = "print")

```
</details>

<details>
<summary>validation</summary>
```{r lme-validation, fig.width = 14, fig.height = 14}
# get predicted outbreak start probability by condition - break into groups by forecasted probability
lme_predict <- augmented_data_val_bootstrap %>%
  mutate(`Full Model` = repel_predict(model_object, .)) %>% 
  mutate(Baseline = repel_predict(model_object_baseline, .)) 

# hist(lme_predict$`Full Model`)
# hist(lme_predict$Baseline)

lme_predict <- lme_predict %>% 
  pivot_longer(cols = c(`Full Model`, "Baseline"), names_to = "model", values_to = "outbreak_start_predict_prob") 


lme_predict_grp <- lme_predict %>% 
  group_by(model) %>% 
  mutate(outbreak_start_predict_prob_grp = cut_number(outbreak_start_predict_prob, n = 30)) %>%
  group_by(model, outbreak_start_predict_prob_grp) %>%
  mutate(outbreak_start_predict_prob_grp_median = median(outbreak_start_predict_prob)) %>%
  group_by(model) %>% 
  mutate(group = outbreak_start_predict_prob_grp_median <= median(outbreak_start_predict_prob_grp_median),
         group = ifelse(group, 1, 2)) %>% # split into two
  ungroup()

ggplot() +
  geom_jitter(data = lme_predict_grp %>% filter(!outbreak_start),
              aes(y = outbreak_start_predict_prob, x= model), color = "gray50", size = 1, alpha = 0.5) +
  geom_jitter(data = lme_predict_grp %>% filter(outbreak_start),
              aes(y = outbreak_start_predict_prob, x= model), color = "red", size = 2, alpha = 1) +
  labs(x = "", y = "Forecasted Probability") +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 16)) +
  NULL


# overall forecast vs actual by binom group
lme_binoms <- lme_predict_grp %>% 
  group_by(model, outbreak_start_predict_prob_grp) %>%
  group_split() %>%
  purrr::map_dfr(., function(tw){
    binom <-  binom.confint(x = sum(tw$outbreak_start), n=nrow(tw), methods = "wilson")
    tw %>%
      distinct(model, outbreak_start_predict_prob_grp, group, outbreak_start_predict_prob_grp_median) %>%
      mutate(outbreak_start_actual_prob = binom$mean, outbreak_start_actual_low = binom$lower, outbreak_start_actual_upper = binom$upper)}) 


options(scipen = 999)
validation_plot <- ggplot(lme_binoms %>% filter(model == "Full Model"), aes(y = outbreak_start_predict_prob_grp_median, x  = outbreak_start_actual_prob, #color = model
)) +
  geom_abline(color = "gray50") +
  geom_errorbar(aes(xmin = outbreak_start_actual_low, xmax = outbreak_start_actual_upper)) +
  geom_point(pch = 21,fill = "white") +
  scale_x_continuous(limits = c(0, max(lme_binoms$outbreak_start_actual_upper))) +
  scale_y_continuous(limits = c(0, max(lme_binoms$outbreak_start_actual_upper))) +
  labs(y = "Forecasted probability", x = "Actual probabilty", color = "",
       caption = paste("Forecasted probabilities are binned into 30 groups by distribution density.\nActual probabilities are binomial probabilities and confidence intervals for actual outbreaks occurring within the forecasted interval")) +
  theme_minimal() +
  theme(text = element_text(size = 16),
        plot.title.position = "plot",
        plot.caption = element_text(hjust = 0)) +
  NULL

validation_plot

# ########################
# validation interval plots by disease
lme_predict_grp_disease <- lme_predict %>%
  filter(disease %in% get_oie_high_importance_diseases()) %>% 
  mutate(disease = str_replace_all(disease, "_", " ")) %>% 
  group_by(model, disease) %>% 
  mutate(outbreak_start_predict_prob_grp = cut_number(outbreak_start_predict_prob, n = 3)) %>%
  group_by(disease, outbreak_start_predict_prob_grp) %>%
  mutate(outbreak_start_predict_prob_grp_median = median(outbreak_start_predict_prob)) %>%
  ungroup()

# overall forecast vs actual by binom group
lme_binoms_disease <- lme_predict_grp_disease %>% 
  filter(model == "Full Model") %>% 
  group_by(disease, outbreak_start_predict_prob_grp) %>%
  group_split() %>%
  purrr::map_dfr(., function(tw){
    binom <-  binom.confint(x = sum(tw$outbreak_start), n=nrow(tw), methods = "wilson")
    tw %>%
      distinct(model, disease, outbreak_start_predict_prob_grp, outbreak_start_predict_prob_grp_median) %>%
      mutate(outbreak_start_actual_prob = binom$mean, outbreak_start_actual_low = binom$lower, outbreak_start_actual_upper = binom$upper)
  }) %>% 
  group_by(disease) %>%
  mutate(brk = max(outbreak_start_actual_upper)) %>% 
  ungroup()

options(scipen = 999)
validation_plot_disease <- ggplot(lme_binoms_disease %>% filter(model == "Full Model"), aes(y = outbreak_start_predict_prob_grp_median, x  = outbreak_start_actual_prob, #color = model
)) +
  geom_abline(color = "gray50") +
  geom_errorbar(aes(xmin = outbreak_start_actual_low, xmax = outbreak_start_actual_upper)) +
  geom_point(pch = 21,fill = "white") +
  facet_wrap(disease ~ ., scales = "free") +
  geom_blank(aes(x = brk, y = brk)) +
  labs(y = "Forecasted probability", x = "Actual probabilty", color = "",
       caption = paste("Forecasted probabilities are binned into 5 groups by distribution density.\nActual probabilities are binomial probabilities and confidence intervals for actual outbreaks occurring within the forecasted interval")) +
  theme_minimal() +
  theme(axis.text = element_text(size = 16),
        title = element_text(size = 16),
        plot.title.position = "plot",
        plot.caption = element_text(hjust = 0)) +
  NULL

validation_plot_disease

ggplot() +
  geom_jitter(data = lme_predict_grp_disease %>% filter(!outbreak_start),
              aes(y = outbreak_start_predict_prob, x= model), color = "gray50", size = 1, alpha = 0.5) +
  geom_jitter(data = lme_predict_grp_disease %>% filter(outbreak_start),
              aes(y = outbreak_start_predict_prob, x= model), color = "red", size = 2, alpha = 1) +
  facet_wrap(disease ~ . , scales = "free") +
  labs(x = "", y = "Forecasted Probability") +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 16)) +
  NULL
```
</details>

