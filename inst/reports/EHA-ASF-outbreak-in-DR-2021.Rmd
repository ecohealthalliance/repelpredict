---
title: "REPEL Memo: July 2021 African Swine Fever Outbreak in the Dominican Republic"
date: "`r Sys.Date()`"
author: "EcoHealth Alliance"
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
---

```{r setup, include=FALSE, cache = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 7, fig.height = 5)
devtools::load_all()
library(ggplot2)
library(ggalt)
library(knitr)
library(cowplot)
conn <- repeldata::repel_remote_conn()
```

__The recent African Swine Fever (ASF) outbreak in Dominican Republic is the first detection of the virus in the Americas. EcoHealth Alliance's REPEL model predicted a median risk for ASF outbreak in the Dominican Republic, reflective of the size of the country's swine population. Now, despite the geographic proximity of the current outbreak to other countries in the Americas, we do not see a large increase in outbreak risk in the western hemisphere (with the exception of Haiti). Nonetheless, the Dominican Republic is now among the most likely origin countries for potential ASF spread into the Americas, highlighting the need for increased security measures. This risk does not greatly exceed other potential source countries from Africa and Asia (e.g., South Africa, Philippines), and therefore continued risk mitigation methods should be applied to all potential global sources of ASF.__

In July 2021, the U.S. Department of Agriculture confirmed an outbreak of African Swine Fever (ASF) in pigs in the Dominican Republic, marking the first detection of the virus in the western hemisphere and raising concerns about potential transmission to the United States. The source of the outbreak in the Dominican Republic is currently unknown. 

Under contract with the DHS Science and Technology Directorate, EcoHealth Alliance (EHA) is developing a predictive machine-learning toolset, known as REPEL (Rapid Evaluation of Pathogens to prevent Epidemics in Livestock), to forecast global animal infectious disease incidence, spread, and impact. Here, we look at REPEL spread model predictions for ASF in the Dominican Republic and evaluate potential spread to other countries in the Americas. 

# ASF outbreak probability in the Americas over the last 3 years
Across the Americas, the predicted outbreak probability of ASF has increased with the global spread of ASF in Asia and Africa (Figure 1). The model incorporates several predictors of spread, including trade of live animals and animal products, geographic proximity, and migratory wildlife overlap between countries. In addition, the model accounts for country characteristics including target taxa populations, human population, number of veterinarians, and GDP. Because ASF has never previously crossed into the Americas, the model heavily weighted target taxa population (i.e., swine) in its prediction of outbreak probability, and as such the USA was considered the highest risk for outbreak and Dominican Republic had a median risk. This risk dropped somewhat in the second half of 2020 due to a decrease in the total number of countries reporting outbreaks.

```{r dr-last-yr, fig.cap = "The probability of an ASF outbreak in a given month in the Americas from August 2018 to August 2021. Each line represents a country."}
americas <- countrycode::codelist %>% 
  filter(continent == "Americas") %>% 
  pull(iso3c)

current_month <- floor_date(Sys.Date(), unit = "month")
prev_year <- floor_date(current_month - 3*365, unit = "month")
months <- seq(from = prev_year, to = current_month, by = "month")

asf_outbreak_in_americas <- tbl(conn,  "network_lme_augment_predict") %>%
  filter(disease %in% "african_swine_fever")  %>%
  filter(country_iso3c %in% americas) %>%
  filter(month %in% months) %>% 
  collect() %>% 
  mutate("Predicted Outbreak Probability (%)" = predicted_outbreak_probability * 100 )

asf_outbreak_in_dom <- asf_outbreak_in_americas %>% 
  mutate(country_label = case_when(
    country_iso3c == "USA" ~ "United States",
    country_iso3c == "DOM" ~ "Dominican Republic",
    TRUE ~ "other"
  )) %>% 
  mutate(country_label = factor(country_label, levels = c("United States", "Dominican Republic", "other"), ordered = TRUE))

ggplot(asf_outbreak_in_dom, aes(x = month, y = `Predicted Outbreak Probability (%)`, group = country_iso3c,
                                color = country_label, alpha = country_label, size = country_label)) + 
  geom_line() + 
  scale_color_manual(values = c("other" = "gray50", "United States" = "#0072B2", "Dominican Republic" = "#CC79A7"), guide = "none") +
  scale_alpha_manual(values = c("other" = 0.5, "United States" = 1, "Dominican Republic" = 1), guide = "none") +
  scale_size_manual(values = c("other" = 0.5, "United States" = 0.5, "Dominican Republic" = 1), guide = "none") +
  geom_label(data=filter(asf_outbreak_in_dom, 
                         country_iso3c == "DOM", month == max(month)),
             aes(x=month, y=`Predicted Outbreak Probability (%)`, label="Dominican Republic"),
             color="#CC79A7", size=5, vjust=-1, hjust=1, fontface="bold") +
  geom_label(data=filter(asf_outbreak_in_dom, 
                         country_iso3c == "USA", month == max(month)),
             aes(x=month, y=`Predicted Outbreak Probability (%)`, label="USA"),
             color="#0072B2", size=5, vjust=0, hjust=1, fontface="bold") +
  labs(x = "",color = "") +
  theme_classic()

```

```{r 2020-dip}
# asf_outbreak_in_americas_disagg <- get_network_variable_importance_with_origins(conn = conn, country_iso3c = "USA", month = months, disease =  "african_swine_fever") 
# 
# asf_outbreak_in_americas_disagg2 <- asf_outbreak_in_americas_disagg %>% 
#   filter(variable == "n_migratory_wildlife_from_outbreaks") 
# 
# asf_outbreak_in_americas_disagg3 <- asf_outbreak_in_americas_disagg2 %>% 
#   arrange(month) %>% 
#   group_by(month) %>% 
#   summarize(n = n(), origin_countries = paste(sort(country_origin), collapse = ";")) 
# 
# asf_outbreak_in_americas_disagg2_split <- asf_outbreak_in_americas_disagg2 %>% 
#   filter(month == "2019-09-01" | month == "2020-06-01" | month == "2021-05-01") %>% 
#   arrange(month) %>% 
#   group_split(month)
# setdiff(asf_outbreak_in_americas_disagg2_split[[1]]$country_origin, asf_outbreak_in_americas_disagg2_split[[2]]$country_origin)
# 
# setdiff(asf_outbreak_in_americas_disagg2_split[[3]]$country_origin, asf_outbreak_in_americas_disagg2_split[[2]]$country_origin)
# 
# 
# ggplot(asf_outbreak_in_americas_disagg3, aes(x = month, y = n)) + 
#   geom_line()


```


```{r americas-june}
# ASF Outbreak Probability in the Americas in June (pre-outbreak)
# asf_outbreak_in_americas_june <- asf_outbreak_in_americas %>% 
#   filter(month == "2021-06-01") %>% 
#   arrange(predicted_outbreak_probability) %>% 
#   mutate(country = countrycode::countrycode(country_iso3c, origin = "iso3c", destination = "country.name")) %>% 
#   mutate(country = forcats::fct_inorder(country))

# ggplot(asf_outbreak_in_americas_june, aes(x = country, y = `Predicted Outbreak Probability (%)`)) +
#   geom_point() + 
#   coord_flip() +
#   theme_classic()
```

```{r probability-hist}
# Are these probabilities "high"? - compare to full outbreak probability dist

# all_probabilities <-  tbl(conn,  "network_lme_augment_predict") %>% 
#   select(predicted_outbreak_probability) %>% 
#   collect() %>% 
#   mutate("Predicted Outbreak Probability (%)" = predicted_outbreak_probability * 100 )

# ggplot() +
#   geom_histogram(data = all_probabilities, aes(x = `Predicted Outbreak Probability (%)`)) + 
#   scale_x_log10() + 
#   geom_vline(data = asf_outbreak_in_americas_june %>%
#                filter(country_iso3c %in% c("USA", "DOM")), 
#              aes(xintercept =  `Predicted Outbreak Probability (%)`, color = country_iso3c)) + 
#   theme_classic()

# quantile(all_probabilities$predicted_outbreak_probability)
# 75%tile = 0.0005642402
# DR =  0.0002116481

dom <-  tbl(conn,  "network_lme_augment_predict") %>%
  filter(disease %in% "african_swine_fever") %>% 
  filter(month == "2021-06-01", country_iso3c == "DOM") %>% 
  collect()

## fao heads
# from 2019
# hard to get up to date predictions without current data
# also DR is not a reporting country to FAO
```

```{r variable-importance-overall}
### What variables are most important in predicting spread of ASF globally?
# randef <- tbl(conn, "network_lme_coefficients") %>% collect()
# randef %>%
#   #filter(str_detect(variable, "from_outbreaks")) %>%
#   filter(disease == "african_swine_fever") %>%
#   filter(!str_detect(variable, "continent")) %>% 
#   mutate(variable_clean = forcats::fct_reorder(variable_clean, coef)) %>%
#   mutate(pos = coef > 0) %>%
#   ggplot() +
#   geom_hline(aes(yintercept = 0), color = "gray50") +
#   geom_point(aes(x = variable_clean, y = coef, color = pos), size = 2) +
#   geom_segment(aes(x = variable_clean, xend = variable_clean, y = coef, yend = 0, color = pos)) +
#   #    scale_y_continuous(limits = c(xmin,  xmax)) +
#   scale_color_manual(values = c("TRUE" = "#0072B2", "FALSE" = "#D55E00")) +
#   labs(y = "Coefficient", x = "") +
#   coord_flip() +
#   theme_minimal() +
#   theme(legend.position = "none",
#         axis.text = element_text(size = 12),
#         title = element_text(size = 12),
#         plot.title.position = "plot") +
#   NULL
```

```{r variable-importance-dr}
# What variables are most important in predicting outbreak of ASF in the DR?
# vi_dom <- get_network_variable_importance(conn,
#                                           country_iso3c = "DOM",
#                                           diseases = "african_swine_fever",
#                                           month = "2021-06-01")
# outbreak_prob <- signif(unique(vi_dom$predicted_outbreak_probability), 2)
# country_name <- unique(vi_dom$country)
# disease_name <- unique(vi_dom$disease_clean)
# year <- year(unique(vi_dom$month))

# vi_dom %>%
#   filter(!variable %in% c("disease_country_combo_unreported", "continentAmericas")) %>% 
#   mutate(variable_clean = forcats::fct_reorder(variable_clean, variable_importance)) %>%
#   ggplot() +
#   geom_vline(aes(xintercept = 0), color = "gray50") +
#   geom_point(aes(x = variable_importance, y = variable_clean, color = pos), size = 2) +
#   geom_segment(aes(x = variable_importance, xend = 0, y = variable_clean, yend = variable_clean, color = pos)) +
#   scale_color_manual(values = c("TRUE" = "#0072B2", "FALSE" = "#D55E00")) +
#   labs(y = "", x = "Variable importance", title = glue::glue("{year} {disease_name} Outbreak in {country_name} Variable Importance ({outbreak_prob} probability outbreak)")) +
#   theme_minimal() +
#   theme(legend.position = "none",
#         axis.text = element_text(size = 10),
#         title = element_text(size = 10),
#         plot.title.position = "plot") +
#   NULL

```

# How does the outbreak in Dominican Republic impact outbreak probability in the Americas?
As expected, the largest jump in predicted ASF outbreak probability occurs in Haiti, which shares a land border with the Dominican Republic (Figure 2). The USA, Mexico, Colombia, and Cuba experience a small increase in outbreak probability. Overall, with the exception of Haiti, our model does not expect the outbreak in the Dominican Republic to substantially increase outbreak risk in the Americas above current baseline risk.

```{r dr-impact, fig.cap = "The probability of an ASF outbreak in the Americas in June 2021 (pre-DR outbreak) and August 2021 (ongoing DR outbreak)"}
asf_outbreak_in_americas_june_aug <- asf_outbreak_in_americas %>% 
  filter(month == "2021-06-01" | month == "2021-08-01") %>% 
  filter(country_iso3c != "DOM") %>% 
  select(country_iso3c, month, `Predicted Outbreak Probability (%)`) %>% 
  mutate(country = countrycode::countrycode(country_iso3c, origin = "iso3c", destination = "country.name")) %>% 
  pivot_wider(names_from = month, values_from = `Predicted Outbreak Probability (%)`) %>% 
  mutate(diff = `2021-08-01` - `2021-06-01`) %>% 
  arrange(diff) %>% 
  mutate(country = forcats::fct_inorder(country)) 

ggplot(asf_outbreak_in_americas_june_aug) +
  geom_dumbbell(aes(y=country, x=`2021-06-01`, xend=`2021-08-01`),
                size=1.5, color="#b2b2b2", size_x=3, size_xend = 3, colour_x = "#56B4E9", colour_xend = "#D55E00") +
  geom_text(data=filter(asf_outbreak_in_americas_june_aug, diff == max(diff)),
            aes(x=`2021-06-01`, y=country, label="June 2021"),
            color="#56B4E9", size=4, vjust=0.25, hjust=1.2, fontface="bold") +
  geom_text(data=filter(asf_outbreak_in_americas_june_aug, diff == max(diff)),
            aes(x=`2021-08-01`, y=country, label="August 2021"),
            color="#D55E00", size=4, vjust=0.25, hjust=-0.2, fontface="bold") +
  labs(x = "Predicted Outbreak Probability (%)", y = "") +
  theme_classic()

```

# What countries are the top contributers to ASF outbreak risk in August 2021? 
The Dominican Republic is now among the most likely origin countries for potential ASF spread to North American countries (USA, Mexico, Canada) and higher-risk countries in the Caribbean and South America (Haiti, Colombia, Cuba). This emergent risk warrants increased border security measures, such as increasing inspections of flights and boats from the Dominican Republic. However, with the exception of Haiti, ASF import risk from the Dominican Republic does not greatly exceed import risk from other high-risk countries, such as South Africa, Philippines, and the Ivory Coast. Therefore, resources and attention should not be diverted from other potential source countries, as the likelihood of ASF arrival from these locations matches the likelihood of arrival from the Dominican Republic.

```{r na-contrib, fig.cap = "Origin country contribution to ASF import probability in select countries in the Americas"}
asf_outbreak_in_americas_import_risk <- get_network_origin_contribution_import_risk(conn, 
                                                                                    country_iso3c = c("USA", "MEX", "CAN",
                                                                                                      "HTI", "COL", "CUB"),
                                                                                    diseases =  "african_swine_fever",
                                                                                    month = "2021-08-01")

plots <- asf_outbreak_in_americas_import_risk %>% 
  mutate(country_iso3c = factor(country_iso3c, levels = c("USA", "MEX", "CAN", "HTI", "COL", "CUB"))) %>% 
  arrange(country_iso3c, -contribution_to_import_risk) %>% 
  mutate(is_dr = country_origin_iso3c == "DOM") %>% 
  group_split(country_iso3c) %>% 
  map(function(x){
    xmod <- x %>% 
      slice(1:10) %>% 
      arrange(contribution_to_import_risk) %>% 
      mutate(country_origin = forcats::fct_inorder(country_origin)) 
    
    title <- unique(xmod$country)
    ggplot(xmod, aes(y = country_origin, x = contribution_to_import_risk, color = is_dr)) +
      geom_point() +
      geom_hline(aes(yintercept = 0), color = "gray50") +
      geom_segment(aes( xend = 0, yend = country_origin)) +
      scale_color_manual(values = c(`FALSE` = "black", `TRUE` = "#CC79A7"), guide = "none") +
      labs(x = "", y = "", title = title) +
      theme_minimal()
  })


cowplot::plot_grid(plotlist = plots)
```

```{r disconn}
dbDisconnect(conn)
```
