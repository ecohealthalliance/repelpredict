---
title: "nowcast model comparison"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(xgboost)
library(readr)
library(repelpredict)
library(cowplot)
library(yardstick)
library(countrycode)
library(recipes)
library(DALEX)

devtools::load_all()

conn <- repeldata::repel_local_conn()
grouping_vars <- c("country_iso3c", "report_year", "report_semester", "disease", "disease_population", "taxa")

traindat <- repel_cases_train(conn) %>%
  select(all_of(grouping_vars)) %>%
  distinct()
```

## Baseline
This model predicts the last available semester case count (integer) or disease status (binary) for a given country + disease + taxa. `NA` values are imputed as `0`. 

```{r baseline}
augmented_data_baseline <- repel_augment(model_object = nowcast_baseline_model(), conn = conn, newdata = traindat)
predicted_cases_baseline <- repel_predict(model_object = nowcast_baseline_model(), newdata = augmented_data_baseline)
scored_data_baseline <- repel_score(model_object = nowcast_baseline_model(), augmented_data = augmented_data_baseline, predicted_cases = predicted_cases_baseline)
scored_data_baseline[-1]
```

## XGBoost
Model and scored results on full training set (using default tuning params)
```{r xgb}
augmented_data_boost <- repel_augment(model_object = nowcast_boost_model(), conn = conn, newdata = traindat)
predicted_cases_boost <- repel_predict(model_object = nowcast_boost_model(), newdata = augmented_data_boost)
scored_data_boost <- repel_score(model_object = nowcast_boost_model(), augmented_data = augmented_data_boost, predicted_cases = predicted_cases_boost)
scored_data_boost[-1]
```

### XGBoost - disease status
```{r xgb_ds, fig.height=10, fig.width=10}
disease_status_comp <- augmented_data_boost %>%
  select(all_of(grouping_vars), disease_status_actual = disease_status) %>%
  mutate(disease_status_predicted = as.integer(predicted_cases_boost>0)) %>%
  mutate(disease_status_match = disease_status_actual == disease_status_predicted) %>% 
  mutate(continent = countrycode::countrycode(country_iso3c, origin = "iso3c", destination = "continent")) 

# confusion matrix by taxa
make_conf_mat <- function(grp_var){
  grp_disease_status <- disease_status_comp %>%
    select(all_of(grp_var), disease_status_actual, disease_status_predicted) %>%
    mutate(disease_status_actual = factor(disease_status_actual)) %>%
    mutate(disease_status_predicted = factor(disease_status_predicted))
  
  cm_grp <- grp_disease_status %>%
    group_by_at(grp_var) %>%
    conf_mat(truth = disease_status_actual, estimate = disease_status_predicted)
  
  cm_rates <- cm_grp %>%
    mutate(tidied = map(conf_mat, tidy)) %>%
    unnest(tidied) %>% 
    mutate(true_status = recode(name, "cell_1_1" = "neg", "cell_2_1" = "neg", "cell_1_2" = "pos", "cell_2_2" = "pos")) %>% 
    mutate(classification = recode(name, "cell_1_1" = "correct", "cell_2_1" = "incorrect", "cell_1_2" = "incorrect", "cell_2_2" = "correct")) %>% 
    mutate(x = recode(name, "cell_1_1" = "0", "cell_2_1" = "0", "cell_1_2" = "1", "cell_2_2" = "1")) %>% 
    mutate(y = recode(name,  "cell_1_1" = "0", "cell_2_1" = "1", "cell_1_2" = "0", "cell_2_2" = "1")) %>% 
    group_by_at(c(grp_var, "true_status")) %>%
    mutate(total = sum(value)) %>% 
    ungroup() %>% 
    mutate(rate = value/total) %>% 
    select(all_of(grp_var), true_status, classification, rate, value, x, y)
  
  accur <- cm_rates %>% 
    filter(classification == "correct") %>% 
    mutate(x_lab = paste0(x, "\n(", signif(100*rate, 3), "% accuracy)")) %>% 
    select(all_of(grp_var), x, x_lab)
  
  cm_rates <- left_join(cm_rates, accur)
  
  vars <- cm_rates %>% 
    pull(grp_var) %>% 
    unique()
  
  cm_plots <- map(vars, function(tx){
    
    dat <- cm_rates %>% 
      filter_at(grp_var, ~.x == tx)
    
    ggplot(dat, aes(x_lab, y, label = value)) +
      geom_tile(aes(fill = value), show.legend = FALSE, alpha = 0.5) +
      geom_label(alpha = 0)+
      scale_fill_viridis_c() +
      labs(x = "truth", y = "predicted", title = tx) +
      theme_bw()
  })
  
  plot_grid(plotlist = cm_plots)
}

make_conf_mat("taxa")
```

```{r xgb_ds2}
make_conf_mat("continent")
```

### XGBoost - diseae status - variable importance
```{r xgb_ds_vi}
# Load model
boost_mod_disease_status <- xgb.load(here::here("models/boost_mod_disease_status.model"))
# Load data
boost_train_disease_status <- read_rds(here::here("models/boost_train_disease_status.rds"))

explainer_disease_status <- DALEX::explain(
  model = boost_mod_disease_status,
  data = boost_train_disease_status$data,
  y = boost_train_disease_status$label,
  predict_function = predict,
  label = "cases"
)

importance_disease_status <- xgb.importance(feature_names = colnames(boost_train_disease_status$data), model = boost_mod_disease_status)
head(importance_disease_status, n = 10)
```

#### XGBoost - disease status - variable importance
```{r xgb_ds_pd, fig.height=10, fig.width=10}

vars_disease_status <- c("disease_status_lag1", "disease_status_lag2", "disease_status_lag3", "log_human_population", "log_taxa_population", "log_veterinarians_per_taxa", "log_gdp_per_capita")

pd_plots_cases <- purrr::map(vars_disease_status, function(var){
  var_resp <- variable_effect(explainer_disease_status, variable =  var , type = "partial_dependency")
  plot(var_resp)
})

  plot_grid(plotlist = pd_plots_cases)

```

### XGBoost - cases
```{r xgb_ca}
# cases actual versus residual- only for predicted cases
cases_comp <- augmented_data_boost %>%
  select(all_of(grouping_vars), cases_actual = cases, cases_lag1) %>%
  mutate(cases_predicted = predicted_cases_boost) %>%
  drop_na(cases_actual) %>% 
  filter(cases_actual > 0) %>%
  filter(cases_predicted > 0) %>%
  mutate(cases_error = abs(cases_actual - cases_predicted)) %>%
  mutate(cases_dirchange_actual = cases_actual - cases_lag1) %>%
  mutate(cases_dirchange_predicted = cases_predicted - cases_lag1) %>%
  mutate_at(.vars = c("cases_dirchange_actual", "cases_dirchange_predicted"),
            ~case_when(. == 0 ~ "no change",
                       . > 0 ~ "increase",
                       . < 0 ~ "decrease",
                       is.na(.) ~ NA_character_)) %>%
  mutate(cases_dirchange_match = cases_dirchange_actual == cases_dirchange_predicted)

cases_comp %>%
  ggplot(., aes(x = cases_actual, y = cases_predicted, color = log10(cases_error))) +
  geom_point(alpha = 0.5) +
  scale_y_log10(limits = c(1, max(c(cases_comp$cases_actual, cases_comp$cases_predicted)))) +
  scale_x_log10(limits = c(1, max(c(cases_comp$cases_actual, cases_comp$cases_predicted)))) +
  scale_color_viridis_c() +
  theme_bw()
```

### XGBoost - cases - variable importance
```{r xgb_ca_vi}
# Load model
boost_mod_cases <- xgb.load(here::here("models/boost_mod_cases.model"))
# Load data
boost_train_cases <- read_rds(here::here("models/boost_train_cases.rds"))

explainer_cases <- DALEX::explain(
  model = boost_mod_cases,
  data = boost_train_cases$data,
  y =boost_train_cases$label,
  predict_function = predict,
  label = "cases"
)

importance_cases <- xgb.importance(feature_names = colnames(boost_train_cases$data), model = boost_mod_cases)
head(importance_cases, n = 10)
```


#### XGBoost - cases - partial dependency
```{r xgb_ca_pd, fig.height=10, fig.width=10}

vars_cases <- c("cases_lag1", "cases_lag2", "cases_lag3", "log_human_population", "log_taxa_population", "log_veterinarians_per_taxa", "log_gdp_per_capita")

pd_plots_cases <- purrr::map(vars_cases, function(var){
  var_resp <- variable_effect(explainer_cases, variable =  var , type = "partial_dependency")
  plot(var_resp)
})

  plot_grid(plotlist = pd_plots_cases)

```
