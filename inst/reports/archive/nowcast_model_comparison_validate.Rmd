---
title: "REPEL nowcast VALIDATION"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 10)
devtools::load_all()
library(yardstick)
library(ggplot2)
library(kableExtra)
library(cowplot)
library(DALEX)
library(rsample)

conn <- repeldata::repel_local_conn()
grouping_vars <- c("country_iso3c", "report_year", "report_semester", "disease", "disease_population", "taxa")

valdat <- annual_reports_animal_hosts_validation(conn) %>%
  select(all_of(grouping_vars)) %>%
  distinct() %>% 
  bootstraps(times = 1) %>% 
  pull(splits) %>% 
  magrittr::extract2(1) %>% 
  as_tibble()
```

```{r load-data}

## baseline
# validate
# augmented_data_baseline_v <- repel_augment(model_object = nowcast_baseline_model(), conn = conn, newdata = valdat)
# predicted_cases_baseline_v <- repel_predict(model_object = nowcast_baseline_model(), newdata = augmented_data_baseline_v)
# scored_data_baseline_v <- repel_score(model_object = nowcast_baseline_model(), augmented_data = augmented_data_baseline_v, predicted_cases = predicted_cases_baseline_v)

forecasted_baseline <- repel_forecast(model_object = nowcast_baseline_model(),
                                  conn = conn,
                                  newdata = valdat)

scored_baseline <- repel_score(model_object = nowcast_baseline_model(),
                               augmented_data = forecasted_baseline$augmented_data,
                               predicted_cases = forecasted_baseline$predicted_cases)


## xgboost
# validate
# augmented_data_boost_v <- repel_augment(model_object = nowcast_boost_model(), conn = conn, newdata = valdat)
# predicted_cases_boost_v <- repel_predict(model_object = nowcast_boost_model(), newdata = augmented_data_boost_v)
# scored_data_boost_v <- repel_score(model_object = nowcast_boost_model(), augmented_data = augmented_data_boost_v, predicted_cases = predicted_cases_boost_v)

model_object <-  nowcast_boost_model(
  disease_status_model = aws.s3::s3readRDS(bucket = "repeldb/models", object = "boost_mod_disease_status.rds"),
  cases_model = aws.s3::s3readRDS(bucket = "repeldb/models", object = "boost_mod_cases.rds"))

forecasted_boost <- repel_forecast(model_object = model_object,
                                  conn = conn,
                                  newdata = valdat, use_cache = TRUE)

scored_boost <- repel_score(model_object = model_object,
                               augmented_data = forecasted_boost$augmented_data,
                               predicted_cases = forecasted_boost$predicted_cases)


```

We are using a two-component hurdle model: first, the model predicts whether a disease will be present (binary), and if present, it predicts the case count (integer). Here we compare the results of a boosted tree model to our baseline model.

### Disease Status
```{r ds-cm}
scored_data_ds_baseline <- scored_baseline$scored_tibble %>% 
  select(taxa, country_iso3c, disease_status_actual, disease_status_predicted, disease_status_dirchange_actual, disease_status_dirchange_predicted) %>% 
  mutate(model = "baseline")
scored_data_ds_boost <- scored_boost$scored_tibble %>% 
  select(taxa, country_iso3c, disease_status_actual, disease_status_predicted, disease_status_dirchange_actual, disease_status_dirchange_predicted) %>% 
  mutate(model = "xgboost")

scored_data_ds <- bind_rows(scored_data_ds_baseline, scored_data_ds_boost) %>% 
  mutate_at(.vars = c("disease_status_actual", "disease_status_predicted", "disease_status_dirchange_actual", "disease_status_dirchange_predicted"), as.factor) %>% 
  mutate(continent = countrycode::countrycode(country_iso3c, origin = "iso3c", destination = "continent")) %>% 
  mutate(full_model = "full_model") # dummy var

metrics <- tribble(~".metric", ~"desc",
                   "accuracy", "proportion of the data that are predicted correctly",
                   "kap", "similar measure to accuracy(), but is normalized by the accuracy that would be expected by chance alone and is very useful when one or more classes have large frequency distributions.",
                   "sens", "the proportion of disease absent predictions out of the number of events which were actually absent",
                   "spec", "the proportion of disease present predictions out of the number of events which were actually present")

ds_summary <- function(grp_var, truth, estimate){
  
  cm_scored_mat <- scored_data_ds %>% 
    mutate(lab = paste(model, get(grp_var), sep = " - ")) %>% 
    group_by_at(c("model", "lab", grp_var)) %>% 
    conf_mat(truth = truth, estimate = estimate) %>% 
    ungroup()
  
  cm_scored_summ <- cm_scored_mat %>% 
    mutate(summary = map(conf_mat, summary)) %>% 
    unnest(summary) %>% 
    right_join(metrics)
  
  out_table <- cm_scored_summ %>% 
    select(one_of(grp_var), .metric, desc, model, .estimate) %>% 
    mutate(.estimate = signif(.estimate, 2)) %>% 
    pivot_wider(names_from = all_of(grp_var), values_from = .estimate) %>% 
    arrange(.metric)
  
  out_plots <- map(cm_scored_mat$conf_mat, autoplot, type = "heatmap")
  out_plots <- plot_grid(plotlist = out_plots, labels = cm_scored_mat$lab, label_size = 8)
  
  return(list(out_table, out_plots))
}

```

<details>
<summary>disease status confusion matrix</summary>
```{r ds-cm-full-model, fig.width = 10, fig.height = 5}
out_full_model <- ds_summary("full_model", truth = "disease_status_actual", estimate = "disease_status_predicted")
out_full_model[[1]]  %>% 
  kbl() %>% 
  collapse_rows(columns = 1:2, valign = "middle") %>% 
  kable_styling() 
out_full_model[[2]]
```
</details>

<details>
<summary>disease status confusion matrix by taxa</summary>
```{r ds-cm-status-taxa, fig.width = 10, fig.height = 10}
out_full_model_taxa <- ds_summary("taxa",  truth = "disease_status_actual", estimate = "disease_status_predicted")
out_full_model_taxa[[1]] %>% 
  select(-desc) %>% 
  kbl() %>% 
  collapse_rows(columns = 1, valign = "middle") %>% 
  kable_styling() 
out_full_model_taxa[[2]]
```
</details>

<details>
<summary>disease status confusion matrix by continent</summary>
```{r ds-cm-status-continent, fig.width = 10, fig.height = 8}
out_full_model_continent <- ds_summary("continent",  truth = "disease_status_actual", estimate = "disease_status_predicted")
out_full_model_continent[[1]]  %>% 
  select(-desc) %>% 
  kbl() %>% 
  collapse_rows(columns = 1, valign = "middle") %>% 
  kable_styling() 
out_full_model_continent[[2]]
```
</details>

<details>
<summary>disease status direction change confusion matrix</summary>
```{r ds-cm-full-model-dc, fig.width = 10, fig.height = 5}
out_full_model_dc <- ds_summary("full_model", truth = "disease_status_dirchange_actual", estimate = "disease_status_dirchange_predicted")
out_full_model_dc[[1]]  %>% 
  filter(! .metric %in% c("sens", "spec")) %>% 
  kbl() %>% 
  collapse_rows(columns = 1:2, valign = "middle") %>% 
  kable_styling() 
out_full_model_dc[[2]]
```
Note there are baseline cases where disease status is positive but cases are NA, which are imputed in the model as 0. 
</details>

<details>
<summary>disease status direction change confusion matrix by taxa</summary>
```{r ds-cm-taxa-dc, fig.width = 15, fig.height = 10}
out_taxa_dc <- ds_summary("taxa", truth = "disease_status_dirchange_actual", estimate = "disease_status_dirchange_predicted")
out_taxa_dc[[1]]  %>% 
  filter(! .metric %in% c("sens", "spec")) %>% 
  select(-desc) %>% 
  kbl() %>% 
  collapse_rows(columns = 1, valign = "middle") %>% 
  kable_styling() 
out_taxa_dc[[2]]
```
</details>

<details>
<summary>disease status direction change confusion matrix by continent</summary>
```{r ds-cm-continent-dc, fig.width = 15, fig.height = 8}
out_continent_dc <- ds_summary("continent", truth = "disease_status_dirchange_actual", estimate = "disease_status_dirchange_predicted")
out_continent_dc[[1]]  %>% 
  filter(! .metric %in% c("sens", "spec")) %>% 
  select(-desc) %>% 
  kbl() %>% 
  collapse_rows(columns = 1, valign = "middle") %>% 
  kable_styling() 
out_continent_dc[[2]]
```
</details>

### Cases
Here we evaluate the subset of the training data with positive case counts

<details>
<summary>cases model stats</summary>
```{r cs-stats}
scored_data_cs_baseline <- scored_baseline$scored_tibble %>%
  select(disease, taxa, country_iso3c, cases_actual, cases_predicted, cases_dirchange_actual, cases_dirchange_predicted, cases_error) %>%
  mutate(model = "baseline") %>%
  drop_na(cases_actual)
scored_data_cs_boost <- scored_boost$scored_tibble%>%
  select(disease, taxa, country_iso3c, cases_actual, cases_predicted, cases_dirchange_actual, cases_dirchange_predicted, cases_error) %>%
  mutate(model = "xgboost") %>%
  drop_na(cases_actual)

scored_data_cs <- bind_rows(scored_data_cs_baseline, scored_data_cs_boost) %>%
  mutate(continent = countrycode::countrycode(country_iso3c, origin = "iso3c", destination = "continent")) %>%
  mutate(full_model = "full_model") # dummy var

scored_data_cs %>%
  group_by(model) %>%
  yardstick::metrics(truth = cases_actual, estimate = cases_predicted)
```
</details>

<details>
<summary>cases residuals</summary>
```{r cd-resid, fig.height=5}
scored_data_cs %>%
  ggplot(., aes(x = cases_actual, y = cases_predicted, color = log10(cases_error))) +
  geom_point(alpha = 0.5) +
  facet_wrap(model ~ .) +
  scale_y_log10(limits = c(1, max(c(scored_data_cs$cases_actual, scored_data_cs$cases_predicted)))) +
  scale_x_log10(limits = c(1, max(c(scored_data_cs$cases_actual, scored_data_cs$cases_predicted)))) +
  scale_color_viridis_c() +
  theme_bw()
```
</details>

<details>
<summary>cases residuals by taxa</summary>
```{r cd-resid-taxa, fig.height=10, fig.width=15}
scored_data_cs %>%
  ggplot(., aes(x = cases_actual, y = cases_predicted, color = log10(cases_error))) +
  geom_point(alpha = 0.5) +
  facet_grid(model ~ taxa) +
  scale_y_log10(limits = c(1, max(c(scored_data_cs$cases_actual, scored_data_cs$cases_predicted)))) +
  scale_x_log10(limits = c(1, max(c(scored_data_cs$cases_actual, scored_data_cs$cases_predicted)))) +
  scale_color_viridis_c() +
  theme_bw()
```
</details>

<details>
<summary>cases residuals by continent</summary>
```{r cd-resid-continent, fig.height=10, fig.width=15}
scored_data_cs %>%
  ggplot(., aes(x = cases_actual, y = cases_predicted, color = log10(cases_error))) +
  geom_point(alpha = 0.5) +
  facet_grid(model ~ continent) +
  scale_y_log10(limits = c(1, max(c(scored_data_cs$cases_actual, scored_data_cs$cases_predicted)))) +
  scale_x_log10(limits = c(1, max(c(scored_data_cs$cases_actual, scored_data_cs$cases_predicted)))) +
  scale_color_viridis_c() +
  theme_bw()
```
</details>

```{r disconnect}
repel_local_disconnect()
```

